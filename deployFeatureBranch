#!/bin/bash

STACKNAME="CodesplainSandbox-$1"

createStack=false
{
  echo "Checking to see if stack exists"
  aws cloudformation describe-stacks --stack-name $STACKNAME --region us-west-2
 } || {
   createStack=true
 }
if [[ $createStack == false ]]; then
  stackStatus=$(echo $(aws cloudformation describe-stacks --stack-name $STACKNAME --region us-west-2) | python -c 'import json,sys;obj=json.load(sys.stdin);print obj["Stacks"][0]["StackStatus"]')
  echo "Stack Status= $stackStatus"
  if [[ $stackStatus == "ROLLBACK_COMPLETE" ]]; then

    echo "Deleting Stack"
    aws cloudformation delete-stack \
      --stack-name $STACKNAME \
      --region us-west-2

    sleep 2
    createStack=true
  fi
fi

if [[ $createStack == true ]]; then
  echo "Creating Stack"
  aws cloudformation deploy \
    --stack-name $STACKNAME \
    --template-file ./serverless-output-sandbox.yaml \
    --parameter-overrides \
      EnvVersion="$1" \
      S3Version="sandbox/$1" \
      ClientSecret="$2" \
      ClientID="$3" \
    --region us-west-2
  exit 0
fi

echo "Updating Stack"
# If stack exists
aws cloudformation update-stack --stack-name $STACKNAME \
  --parameters ParameterKey=S3Version,ParameterValue="dev/$CIRCLE_SHA1" \
    ParameterKey=EnvVersion,ParameterValue="$1" \
    ParameterKey=S3Version,ParameterValue="sandbox/$1" \
    ParameterKey=ClientSecret,ParameterValue="$2" \
    ParameterKey=ClientID,ParameterValue="$3" \
   --use-previous-template \
   --region us-west-2
