machine:
  node:
    version: 7.7.2

test:
  override:
    - npm test

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - bash publish codesplain-lambda-functions/$CIRCLE_TAG
  master:
    branch: master
    commands:
      - bash publish codesplain-lambda-functions/dev/$CIRCLE_SHA1
      - aws cloudformation update-stack --stack-name CodesplainDev --parameters ParameterKey=S3Version,ParameterValue="dev/$CIRCLE_SHA1" --use-previous-template --region us-west-2
  feature:
    branch: /^((?!master).)*$/ # not master
    commands:
      - aws --version
      - bash publish codesplain-lambda-functions/sandbox/$CIRCLE_BRANCH
      - aws cloudformation deploy --template-file ./serverless-output-sandbox.yaml -stack-name "Codesplain-$CIRCLE_BRANCH" --parameter-overrides EnvVersion="$CIRCLE_BRANCH" S3Version="sandbox/$CIRCLE_BRANCH" ClientSecret="$AuthSecret" ClientID="$AuthID" --region us-west-2
