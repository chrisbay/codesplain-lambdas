machine:
  node:
    version: 7.7.2
  environment:
    Test: test
    EnvVersion: echo "$v0.4" | tr . _
    CloudFormationVersion: echo "$0.4" | tr . -

dependencies:
  override:
    - npm install
    - pip install -r requirements.txt

test:
  override:
    - npm test

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    environment:
      EnvVersion: echo "$CIRCLE_TAG" | tr . _
      CloudFormationVersion: echo "$CIRCLE_TAG" | tr . -
    commands:
      # Zip and deploy lambda code to S3
      - bash publish codesplain-lambda-functions/$CIRCLE_TAG

      # Package template for deloying prod
      - >
        aws cloudformation package --template-file featureBranchDeploy.yaml
        --s3-bucket codesplain-lambda-functions
        --output-template-file serverless-output.yaml

      # Deploy a new stack for this version
      - >
        aws cloudformation deploy
        --stack-name "Codesplain-Prod-$CloudFormationVersion"
        --template-file ./serverless-output.yaml
        --parameter-overrides
        EnvVersion="dev"
        S3Version="dev/$CIRCLE_SHA1"
        ClientSecret="$CLIENT_SECRET_DEV"
        ClientID="$CLIENT_ID_DEV"
        Title="Codesplain API: Dev Environment"
        CircleBuild="$CIRCLE_BUILD_NUM"
        --region us-west-2

  master:
    branch: master
    commands:
      # Zip and deploy lambda code to S3
      - bash publish codesplain-lambda-functions/dev/$CIRCLE_SHA1

      # Package template for deloying Dev/Sandbox
      - >
        aws cloudformation package --template-file featureBranchDeploy.yaml
        --s3-bucket codesplain-lambda-functions
        --output-template-file serverless-output.yaml

      # Update Dev stack wtih current template and code changes
      - >
        aws cloudformation deploy
        --stack-name "CodesplainDev"
        --template-file ./serverless-output.yaml
        --parameter-overrides
        EnvVersion="dev"
        S3Version="dev/$CIRCLE_SHA1"
        ClientSecret="$CLIENT_SECRET_DEV"
        ClientID="$CLIENT_ID_DEV"
        Title="Codesplain API: Dev Environment"
        CircleBuild="$CIRCLE_BUILD_NUM"
        --region us-west-2

      # Update Sandbox/Localhost stack with current template and code changes
      - >
        aws cloudformation deploy
        --stack-name "Codesplain-Local"
        --template-file ./serverless-output.yaml
        --parameter-overrides
        EnvVersion="sandbox"
        S3Version="dev/$CIRCLE_SHA1"
        ClientSecret="$CLIENT_SECRET_LOCAL"
        ClientID="$CLIENT_ID_LOCAL"
        Title="Codesplain API:Localhost"
        CircleBuild="$CIRCLE_BUILD_NUM"
        --region us-west-2

      # Remove Cloudformation Stack from merged Feature Branch
      - bash scripts/cleanup $CIRCLE_SHA1

  feature:
    branch: /^((?!master).)*$/ # not master
    commands:
      - echo $Test
      - echo $EnvVersion
      - echo $CloudFormationVersion
      # Zip and push lambda code to S3 bucket under sandbox/branch
      - bash publish codesplain-lambda-functions/sandbox/$CIRCLE_BRANCH

      # Package template for deploying to feature branch API
      - >
        aws cloudformation package --template-file featureBranchDeploy.yaml
        --s3-bucket codesplain-lambda-functions
        --output-template-file serverless-output-sandbox.yaml

      # Deploy or update feature stack based on new lambda code and template
      - >
        aws cloudformation deploy
        --stack-name "CodesplainFeature-$CIRCLE_BRANCH"
        --template-file ./serverless-output-sandbox.yaml
        --parameter-overrides
        EnvVersion="$CIRCLE_BRANCH"
        S3Version="sandbox/$CIRCLE_BRANCH"
        ClientSecret="$AuthSecret"
        ClientID="$AuthId"
        Title="Codesplain Feature:$CIRCLE_BRANCH-$CIRCLE_BUILD_NUM"
        CircleBuild="$CIRCLE_BUILD_NUM"
        --region us-west-2
