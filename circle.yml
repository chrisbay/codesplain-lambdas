machine:
  node:
    version: 7.7.2

dependencies:
  override:
    - npm install
    - pip install -r requirements.txt

test:
  override:
    - npm test

deployment:
  release:
    tag: /v[0-9]+(\.[0-9]+)*/
    commands:
      - bash publish codesplain-lambda-functions/$CIRCLE_TAG
  master:
    branch: master
    commands:
      - bash publish codesplain-lambda-functions/dev/$CIRCLE_SHA1
      - aws cloudformation update-stack --stack-name CodesplainDev --parameters ParameterKey=S3Version,ParameterValue="dev/$CIRCLE_SHA1" --use-previous-template --region us-west-2
  feature:
    branch: /^((?!master).)*$/ # not master
    commands:
      - aws --version
      - bash publish codesplain-lambda-functions/sandbox/$CIRCLE_BRANCH
      - bash deployFeatureBranch $CIRCLE_BRANCH $AuthSecret $AuthId
